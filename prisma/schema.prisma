generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ListingStatus {
  AVAILABLE
  RESERVED
  SOLD
}

enum TransactionType {
  SELL
  RENT
}

enum DeliveryOption {
  MEETUP
  DELIVERY
  PICKUP
}

enum ReportStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
}

model User {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  universityEmail String   @unique
  imageUrl        String?
  campus          String?
  createdAt       DateTime @default(now())
  listings        Listing[]
  messages        Message[]
  participants    ConversationParticipant[]
  savedListings   SavedListing[]
  reviewsReceived Review[] @relation("reviewsReceived")
  reviewsWritten  Review[] @relation("reviewsWritten")
  reports         Report[]
}

model Listing {
  id              String          @id @default(cuid())
  title           String
  description     String
  priceCents      Int
  currency        String          @default("USD")
  category        String
  condition       String
  status          ListingStatus   @default(AVAILABLE)
  transactionType TransactionType @default(SELL)
  rentalPeriodDays Int?
  deliveryOptions String[]
  campus          String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  images          ListingImage[]
  conversations   Conversation[]
  savedBy         SavedListing[]
  reviews         Review[]
  reports         Report[]
}

model ListingImage {
  id        String   @id @default(cuid())
  url       String
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model Conversation {
  id        String   @id @default(cuid())
  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])
  createdAt DateTime @default(now())
  participants ConversationParticipant[]
  messages  Message[]
}

model ConversationParticipant {
  id             String        @id @default(cuid())
  conversationId String
  userId         String
  lastReadAt     DateTime?
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  body           String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id])
}

model SavedListing {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

model Review {
  id         String   @id @default(cuid())
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  sellerId   String
  reviewerId String
  listingId  String?
  seller     User     @relation("reviewsReceived", fields: [sellerId], references: [id])
  reviewer   User     @relation("reviewsWritten", fields: [reviewerId], references: [id])
  listing    Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)
}

model Report {
  id         String       @id @default(cuid())
  reason     String
  details    String?
  status     ReportStatus @default(OPEN)
  createdAt  DateTime     @default(now())
  listingId  String
  reporterId String
  listing    Listing      @relation(fields: [listingId], references: [id], onDelete: Cascade)
  reporter   User         @relation(fields: [reporterId], references: [id])
}
