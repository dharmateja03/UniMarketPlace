generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum ListingStatus {
  AVAILABLE
  RESERVED
  SOLD
}

enum TransactionType {
  SELL
  RENT
}

enum DeliveryOption {
  MEETUP
  DELIVERY
  PICKUP
}

enum ReportStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
}

enum TransactionRole {
  BUYER
  SELLER
}

model User {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  universityEmail String   @unique
  phone           String?
  imageUrl        String?
  campus          String?
  isVerified      Boolean  @default(false)
  createdAt       DateTime @default(now())
  listings        Listing[]
  messages        Message[]
  participants    ConversationParticipant[]
  savedListings   SavedListing[]
  reviewsReceived Review[] @relation("reviewsReceived")
  reviewsWritten  Review[] @relation("reviewsWritten")
  reports         Report[]
  sales           Transaction[] @relation("sales")
  purchases       Transaction[] @relation("purchases")
  following       Follow[] @relation("following")
  followers       Follow[] @relation("followers")
  bundles         Bundle[]
  offersMade      Offer[]  @relation("offersMade")
  offersReceived  Offer[]  @relation("offersReceived")
}

model Listing {
  id              String          @id @default(cuid())
  title           String
  description     String
  priceCents      Int
  currency        String          @default("USD")
  category        String
  condition       String
  status          ListingStatus   @default(AVAILABLE)
  transactionType TransactionType @default(SELL)
  rentalPeriodDays Int?
  flairs          String[]
  deliveryOptions String[]
  campus          String
  viewCount       Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  images          ListingImage[]
  conversations   Conversation[]
  savedBy         SavedListing[]
  reviews         Review[]
  reports         Report[]
  transactions    Transaction[]
  offers          Offer[]
  bundleId        String?
  bundle          Bundle?         @relation(fields: [bundleId], references: [id], onDelete: SetNull)
  moveInDate      DateTime?
  moveOutDate     DateTime?
  furnished       Boolean?
  roommates       Int?
  petsAllowed     Boolean?
  originalPriceCents Int?
  discountPercent    Int?
  saleEndsAt         DateTime?
  reviewsDisabled    Boolean         @default(false)
  showEmail          Boolean         @default(false)
  showPhone          Boolean         @default(false)
  views              ListingView[]
}

model ListingView {
  id         String   @id @default(cuid())
  listingId  String
  userId     String
  viewedAt   DateTime @default(now())
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, userId])
}

model ListingImage {
  id        String   @id @default(cuid())
  url       String
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model Conversation {
  id        String   @id @default(cuid())
  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])
  createdAt DateTime @default(now())
  participants ConversationParticipant[]
  messages  Message[]
}

model ConversationParticipant {
  id             String        @id @default(cuid())
  conversationId String
  userId         String
  lastReadAt     DateTime?
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  body           String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id])
}

model SavedListing {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

model Review {
  id            String           @id @default(cuid())
  rating        Int
  comment       String?
  createdAt     DateTime         @default(now())
  sellerId      String
  reviewerId    String
  listingId     String?
  transactionId String?
  role          TransactionRole?
  seller        User             @relation("reviewsReceived", fields: [sellerId], references: [id])
  reviewer      User             @relation("reviewsWritten", fields: [reviewerId], references: [id])
  listing       Listing?         @relation(fields: [listingId], references: [id], onDelete: SetNull)
  transaction   Transaction?     @relation(fields: [transactionId], references: [id])

  @@unique([transactionId, reviewerId])
}

model Report {
  id         String       @id @default(cuid())
  reason     String
  details    String?
  status     ReportStatus @default(OPEN)
  createdAt  DateTime     @default(now())
  listingId  String
  reporterId String
  listing    Listing      @relation(fields: [listingId], references: [id], onDelete: Cascade)
  reporter   User         @relation(fields: [reporterId], references: [id])
}

model Transaction {
  id          String   @id @default(cuid())
  listingId   String
  sellerId    String
  buyerId     String
  priceCents  Int
  completedAt DateTime @default(now())
  listing     Listing  @relation(fields: [listingId], references: [id])
  seller      User     @relation("sales", fields: [sellerId], references: [id])
  buyer       User     @relation("purchases", fields: [buyerId], references: [id])
  reviews     Review[]

  @@unique([listingId, buyerId])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
}

enum OfferStatus {
  PENDING
  ACCEPTED
  DECLINED
  COUNTERED
}

model Offer {
  id          String      @id @default(cuid())
  amountCents Int
  message     String?
  status      OfferStatus @default(PENDING)
  createdAt   DateTime    @default(now())
  listingId   String
  buyerId     String
  sellerId    String
  listing     Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer       User        @relation("offersMade", fields: [buyerId], references: [id])
  seller      User        @relation("offersReceived", fields: [sellerId], references: [id])
}

model Bundle {
  id              String   @id @default(cuid())
  title           String
  description     String?
  discountPercent Int      @default(0)
  userId          String
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])
  listings        Listing[]
}
